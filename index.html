<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Task Tracker</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Canvas Confetti library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevent horizontal scroll on the body */
        }
        
        /* Style for the scrollbar */
        .kanban-column-body::-webkit-scrollbar {
            width: 8px;
        }
        .kanban-column-body::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .kanban-column-body::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .kanban-column-body::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Styling for the task cards when being dragged */
        .task.dragging {
            opacity: 0.5;
            transform: rotate(3deg);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Highlight drop zones on drag over */
        .kanban-column.drag-over {
            background-color: #f0f9ff; /* A light blue to indicate a valid drop target */
            border-color: #3b82f6;
            border-style: dashed;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main App Container -->
    <div id="app" class="min-h-screen flex flex-col p-4 sm:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="mb-6 flex flex-col sm:flex-row justify-between items-center">
            <div class="text-center sm:text-left">
                <h1 class="text-3xl font-bold text-gray-900">Kanban Task Tracker</h1>
                <p class="text-gray-500 mt-1">Drag and drop tasks to organize your workflow.</p>
            </div>
            <button id="addTaskBtn" class="mt-4 sm:mt-0 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75 transition duration-300 ease-in-out flex items-center">
                <i class="fas fa-plus mr-2"></i> Add New Task
            </button>
        </header>

        <!-- Collaboration Info -->
         <div id="userInfo" class="mb-4 p-3 bg-blue-100 border border-blue-200 text-blue-800 rounded-lg text-sm text-center break-all">
            Loading user and session information...
        </div>

        <!-- Kanban Board -->
        <main id="kanban-board" class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- To Do Column -->
            <div id="todo" class="kanban-column bg-white rounded-xl shadow-md flex flex-col">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold flex items-center">
                        <i class="fas fa-list-ul mr-3 text-red-500"></i> To Do
                    </h2>
                </div>
                <div class="kanban-column-body p-4 flex-grow overflow-y-auto" style="min-height: 400px;">
                    <!-- Tasks for 'To Do' will be inserted here -->
                </div>
            </div>
            
            <!-- In Progress Column -->
            <div id="inprogress" class="kanban-column bg-white rounded-xl shadow-md flex flex-col">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold flex items-center">
                        <i class="fas fa-spinner fa-spin mr-3 text-yellow-500"></i> In Progress
                    </h2>
                </div>
                <div class="kanban-column-body p-4 flex-grow overflow-y-auto" style="min-height: 400px;">
                    <!-- Tasks for 'In Progress' will be inserted here -->
                </div>
            </div>
            
            <!-- Done Column -->
            <div id="done" class="kanban-column bg-white rounded-xl shadow-md flex flex-col">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold flex items-center">
                        <i class="fas fa-check-circle mr-3 text-green-500"></i> Done
                    </h2>
                </div>
                <div class="kanban-column-body p-4 flex-grow overflow-y-auto" style="min-height: 400px;">
                    <!-- Tasks for 'Done' will be inserted here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4">Add New Task</h2>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <div class="mb-4">
                    <label for="taskTitle" class="block text-sm font-medium text-gray-700">Title</label>
                    <input type="text" id="taskTitle" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-6">
                    <label for="taskDescription" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="taskDescription" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
            <h2 class="text-lg font-bold mb-4">Are you sure?</h2>
            <p id="confirmMessage" class="text-gray-600 mb-6">Do you really want to delete this task? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="confirmCancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancel</button>
                <button id="confirmDeleteBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Delete</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase and App Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-kanban-app';
        
        let app, auth, db, userId;
        let tasksCollection;

        // --- UI Elements ---
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskModal = document.getElementById('taskModal');
        const taskForm = document.getElementById('taskForm');
        const cancelBtn = document.getElementById('cancelBtn');
        const confirmModal = document.getElementById('confirmModal');
        const confirmCancelBtn = document.getElementById('confirmCancelBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const userInfoDiv = document.getElementById('userInfo');
        let taskToDeleteId = null;

        // --- Initialize Firebase and Auth ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User is signed in with UID:", userId);
                        setupApp();
                    } else {
                        console.log("No user signed in, attempting to sign in.");
                        await authenticateUser();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                userInfoDiv.textContent = 'Error: Could not connect to the database.';
            }
        }
        
        async function authenticateUser() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                userInfoDiv.textContent = 'Error: Authentication failed.';
            }
        }

        // --- Setup App after Auth ---
        function setupApp() {
            // Define the path for our public, collaborative tasks
            const collectionPath = `/artifacts/${appId}/public/data/tasks`;
            tasksCollection = collection(db, collectionPath);
            
            // Display user/session info for collaboration
            userInfoDiv.innerHTML = `
                <span class="font-semibold">Share this board!</span> Your App ID is: 
                <strong class="font-mono bg-blue-200 px-1 rounded">${appId}</strong>. 
                Your User ID: <strong class="font-mono bg-blue-200 px-1 rounded">${userId}</strong>
            `;

            // Listen for real-time updates to tasks
            const q = query(tasksCollection);
            onSnapshot(q, (snapshot) => {
                clearBoard();
                snapshot.docs.forEach(doc => {
                    renderTask({ ...doc.data(), id: doc.id });
                });
            }, (error) => {
                console.error("Error fetching tasks:", error);
                alert("Could not fetch tasks. Please check the console for errors.");
            });

            setupEventListeners();
        }

        // --- Task Rendering ---
        function clearBoard() {
            document.querySelectorAll('.kanban-column-body').forEach(col => col.innerHTML = '');
        }

        function renderTask(task) {
            const column = document.getElementById(task.status);
            if (!column) {
                console.warn(`Column for status "${task.status}" not found.`);
                return;
            }

            const taskCard = document.createElement('div');
            taskCard.id = task.id;
            taskCard.className = 'task bg-gray-50 border border-gray-200 rounded-lg p-3 mb-3 cursor-grab active:cursor-grabbing shadow-sm hover:shadow-md transition-shadow duration-200';
            taskCard.draggable = true;

            taskCard.innerHTML = `
                <div class="flex justify-between items-start">
                    <h3 class="font-semibold text-gray-800">${task.title}</h3>
                    <div class="flex space-x-2 text-gray-400">
                        <button class="edit-btn hover:text-indigo-600"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn hover:text-red-600"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
                <p class="text-gray-600 mt-2 text-sm">${task.description || ''}</p>
            `;

            column.querySelector('.kanban-column-body').appendChild(taskCard);

            // Add event listeners for the new task card
            taskCard.addEventListener('dragstart', handleDragStart);
            taskCard.querySelector('.edit-btn').addEventListener('click', () => openModal(task));
            taskCard.querySelector('.delete-btn').addEventListener('click', () => openConfirmModal(task.id));
        }

        // --- Modal Handling ---
        function openModal(task = null) {
            taskForm.reset();
            const modalTitle = document.getElementById('modalTitle');
            const taskIdInput = document.getElementById('taskId');
            if (task) {
                modalTitle.textContent = 'Edit Task';
                taskIdInput.value = task.id;
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskDescription').value = task.description;
            } else {
                modalTitle.textContent = 'Add New Task';
                taskIdInput.value = '';
            }
            taskModal.classList.remove('hidden');
        }

        function closeModal() {
            taskModal.classList.add('hidden');
        }

        function openConfirmModal(taskId) {
            taskToDeleteId = taskId;
            confirmModal.classList.remove('hidden');
        }

        function closeConfirmModal() {
            confirmModal.classList.add('hidden');
            taskToDeleteId = null;
        }

        // --- CRUD Operations (Create, Update, Delete) ---
        async function handleFormSubmit(e) {
            e.preventDefault();
            const taskId = document.getElementById('taskId').value;
            const taskData = {
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                authorId: userId,
            };

            try {
                if (taskId) { // Update existing task
                    const taskRef = doc(db, tasksCollection.path, taskId);
                    await setDoc(taskRef, taskData, { merge: true });
                } else { // Create new task
                    taskData.status = 'todo'; // Default status
                    taskData.createdAt = serverTimestamp();
                    await addDoc(tasksCollection, taskData);
                }
                closeModal();
            } catch (error) {
                console.error("Error saving task:", error);
                alert("Failed to save task. See console for details.");
            }
        }

        async function deleteTask() {
            if (!taskToDeleteId) return;
            try {
                await deleteDoc(doc(db, tasksCollection.path, taskToDeleteId));
                closeConfirmModal();
            } catch (error) {
                console.error("Error deleting task:", error);
                alert("Failed to delete task. See console for details.");
            }
        }

        // --- Drag and Drop Handlers ---
        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.id);
            e.target.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow dropping
            const column = e.currentTarget;
            column.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            const column = e.currentTarget;
            column.classList.remove('drag-over');
        }

        async function handleDrop(e) {
            e.preventDefault();
            const taskId = e.dataTransfer.getData('text/plain');
            const targetColumn = e.currentTarget;
            const newStatus = targetColumn.id;
            
            const draggedElement = document.getElementById(taskId);
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
            }
            targetColumn.classList.remove('drag-over');

            // Update task status in Firestore
            try {
                const taskRef = doc(db, tasksCollection.path, taskId);
                await setDoc(taskRef, { status: newStatus }, { merge: true });
                
                // If moved to 'Done', trigger confetti!
                if (newStatus === 'done') {
                    launchConfetti();
                }
            } catch (error) {
                console.error("Error updating task status:", error);
                alert("Failed to move task. See console for details.");
            }
        }

        // --- Confetti ---
        function launchConfetti() {
            confetti({
                particleCount: 150,
                spread: 90,
                origin: { y: 0.6 }
            });
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            addTaskBtn.addEventListener('click', () => openModal());
            cancelBtn.addEventListener('click', closeModal);
            taskForm.addEventListener('submit', handleFormSubmit);

            // Confirmation modal listeners
            confirmCancelBtn.addEventListener('click', closeConfirmModal);
            confirmDeleteBtn.addEventListener('click', deleteTask);

            // Drag and drop listeners for columns
            document.querySelectorAll('.kanban-column').forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('dragleave', handleDragLeave);
                column.addEventListener('drop', handleDrop);
            });
        }

        // --- Start the App ---
        document.addEventListener('DOMContentLoaded', initializeFirebase);

    </script>
</body>
</html>
